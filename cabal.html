<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Using Cabal</title>
  <meta name="description" content="Personal website">

  <link href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700&amp;subset=latin-ext" rel="stylesheet">
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://edom.github.io/cabal.html">
  <link rel="alternate" type="application/rss+xml" title="Erik Dominikus" href="/feed.xml">

  

  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-12628443-6', 'auto');
  ga('send', 'pageview');

</script>
  

  

  
</head>


  <body>

    <header class="site-header" role="banner">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">Erik Dominikus</a>
  </div>
</header>


    

    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Using Cabal</h1>
  </header>

  <div class="post-content">
    <ul>
  <li>Every package used by Setup.hs must have a vanilla version.
    <ul>
      <li>Why I encountered this error:
        <ul>
          <li>I set <code class="highlighter-rouge">library-vanilla</code> to <code class="highlighter-rouge">False</code> due to https://rybczak.net/2016/03/26/how-to-reduce-compilation-times-of-haskell-projects/</li>
        </ul>
      </li>
      <li>How I encountered this error:
        <ul>
          <li>HDBC-postgresql-2.3.2.5 <code class="highlighter-rouge">Setup.hs</code> build fails due to linking error with <code class="highlighter-rouge">shared: True</code>.
            <ul>
              <li>The offending packages are <code class="highlighter-rouge">old-time</code> and <code class="highlighter-rouge">old-locale</code>.
                <ul>
                  <li>It’s OK if we build them as shared library, but we must also build their vanilla version.</li>
                </ul>
              </li>
              <li>It’s not the library content that fails to build. It’s the Cabal Setup of the library that fails to link.</li>
              <li>GHC expects that <code class="highlighter-rouge">old-time</code> and <code class="highlighter-rouge">old-locale</code> are system libraries?</li>
              <li>GHC passes ‘-lHSold-time-VERSION-HASH.so’. It passes that in the -l switch to GCC.</li>
              <li>Cabal writes ‘libHSold-time-VERSION-HASH-ghc-8.2.2.so’.
                <ul>
                  <li>Note the <code class="highlighter-rouge">ghc-8.2.2</code> part isn’t in the string passed by GHC to GCC.</li>
                </ul>
              </li>
              <li>Can we solve this by <code class="highlighter-rouge">cabal install old-time old-locale</code>?</li>
              <li>https://github.com/haskell/cabal/issues/1720
                <ul>
                  <li>Workaround: Add <code class="highlighter-rouge">--ghc-options=-dynamic</code> to cabal new-install</li>
                </ul>
              </li>
              <li>How do we tell Cabal to use the version we installed with new-install?</li>
              <li>Where should we fix this? Cabal? GHC? HDBC-postgresql?</li>
              <li>Should we find another library? Hackage has a low-level libpgsql wrapper.</li>
              <li>Should we just disable HDBC-postgresql on meta?</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>How I diagnosed it:
        <ul>
          <li>Pass <code class="highlighter-rouge">-v</code> to GHC (create a bash script named <code class="highlighter-rouge">ghc</code> that calls <code class="highlighter-rouge">SOMEWHERE/ghc -v "$@"</code>, and put its directory in front of <code class="highlighter-rouge">PATH</code>).</li>
          <li>Add <code class="highlighter-rouge">-v</code> to <code class="highlighter-rouge">cabal</code>. Then look at this fragment. It’s suspicious that <code class="highlighter-rouge">old-time</code> is the only package with a hash.
            <div class="highlighter-rouge"><pre class="highlight"><code>package flags [-package-id Cabal-2.0.1.0{unit Cabal-2.0.1.0 True ([])},
 -package-id array-0.5.2.0{unit array-0.5.2.0 True ([])},
 -package-id base-4.10.1.0{unit base-4.10.1.0 True ([])},
 -package-id binary-0.8.5.1{unit binary-0.8.5.1 True ([])},
 -package-id bytestring-0.10.8.2{unit bytestring-0.10.8.2 True ([])},
 -package-id containers-0.5.10.2{unit containers-0.5.10.2 True ([])},
 -package-id deepseq-1.4.3.0{unit deepseq-1.4.3.0 True ([])},
 -package-id directory-1.3.0.2{unit directory-1.3.0.2 True ([])},
 -package-id filepath-1.4.1.2{unit filepath-1.4.1.2 True ([])},
 -package-id ghc-prim-0.5.1.1{unit ghc-prim-0.5.1.1 True ([])},
 -package-id old-time-1.1.0.3-8c2cc8e5fb3b424e71501141225064c5d9ee4eeba7f40b702227ad1c3ea2c5b7{unit old-time-1.1.0.3-8c2cc8e5fb3b424e71501141225064c5d9ee4eeba7f40b702227ad1c3ea2c5b7 True ([])},
 -package-id pretty-1.1.3.3{unit pretty-1.1.3.3 True ([])},
 -package-id process-1.6.1.0{unit process-1.6.1.0 True ([])},
 -package-id template-haskell-2.12.0.0{unit template-haskell-2.12.0.0 True ([])},
 -package-id time-1.8.0.2{unit time-1.8.0.2 True ([])},
 -package-id transformers-0.5.2.0{unit transformers-0.5.2.0 True ([])},
 -package-id unix-2.7.2.2{unit unix-2.7.2.2 True ([])}]
</code></pre>
            </div>
          </li>
        </ul>
      </li>
      <li>How I solved it:
        <ul>
          <li>I added this fragment to <code class="highlighter-rouge">cabal.project</code>:
```
package old-time
library-vanilla: True</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>package old-locale
library-vanilla: True
```
    - Related
        - https://github.com/haskell/cabal/issues/4748
        - <a href="https://github.com/commercialhaskell/stack/issues/3409">#3409 Can’t use system GHC without static libraries at all</a>
        - <a href="https://github.com/haskell/cabal/issues/1720">#1720 <code class="highlighter-rouge">executable-dynamic: True</code> should apply to <code class="highlighter-rouge">build-type: Custom</code> setup</a></p>
<ul>
  <li><a href="https://github.com/haskell/cabal/issues/4506">#4506 <code class="highlighter-rouge">new-haddock</code>’s file monitoring broken</a>
    <ul>
      <li><code class="highlighter-rouge">new-haddock</code> doesn’t work after <code class="highlighter-rouge">new-build</code>.</li>
    </ul>
  </li>
  <li><a href="https://github.com/haskell/cabal/issues/5290">#5290 new-build runs into internal error after deleting from store</a>
    <ul>
      <li>Solution: nuke the entire store: <code class="highlighter-rouge">rm -r ~/.cabal/store</code>.</li>
    </ul>
  </li>
  <li>Non-problems
    <ul>
      <li><code class="highlighter-rouge">cabal new-build --disable-optimization</code> doesn’t disable optimization of transitive dependencies.
        <ul>
          <li>Cannot reproduce this in cabal 2.3. Is this a 2.0.0.1 bug?</li>
          <li><code class="highlighter-rouge">$HOME/.cabal/config</code> has <code class="highlighter-rouge">optimization: False</code>.</li>
          <li>Is this a regression? Oversight? It works with <code class="highlighter-rouge">cabal install</code>.</li>
          <li>What I’m trying to do:
            <ul>
              <li>Build transitive dependencies with optimization disabled, for faster development.</li>
            </ul>
          </li>
          <li>My guess:
            <ul>
              <li>There seems to be a problem in how the new code path plumbs down arguments.</li>
              <li><code class="highlighter-rouge">"Using internal setup method with build-type"</code> always gets argument <code class="highlighter-rouge">--enable-optimization</code>.
                <ul>
                  <li>That message is printed by <code class="highlighter-rouge">./Distribution/Client/SetupWrapper.hs:418</code> <code class="highlighter-rouge">internalSetupMethod</code> if <code class="highlighter-rouge">cabal new-repl</code> is run with <code class="highlighter-rouge">--verbose</code>.</li>
                  <li>Where does that <code class="highlighter-rouge">--enable-optimization</code> come from?</li>
                  <li>Why isn’t the <code class="highlighter-rouge">--disable-optimization</code> passed down?</li>
                </ul>
              </li>
            </ul>
          </li>
          <li>Related issues:
            <ul>
              <li><a href="https://github.com/haskell/cabal/issues/3720">#3720 Tracking bug for cabal.project semantics</a></li>
              <li><a href="https://github.com/haskell/cabal/issues/5353">#5353 cabal new-configure –disable-optimization has no effect if ghc-options in cabal file contain optimization flag</a></li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Cabal codebase
    <ul>
      <li>Seemingly minor codebase maintenance problems
        <ul>
          <li>Code duplication
            <ul>
              <li><code class="highlighter-rouge">CmdRepl.hs</code> seems to be copied from <code class="highlighter-rouge">CmdBuild.hs</code>.</li>
            </ul>
          </li>
          <li><code class="highlighter-rouge">CmdBuild.hs</code> imports <code class="highlighter-rouge">...Orchestration</code> unqualified without explicit import list</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

  </div>

</article>

      </div>
    </main>

    
    
<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
var disqus_config = function () {
    this.page.url = "https://edom.github.io/cabal.html";  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = "https://edom.github.io/cabal.html"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://edom-github-io.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    

    <footer class="site-footer h-card">
    <data class="u-url" href="/"></data>

    <div class="wrapper">
        <p>This page was created on 2018-08-08 00:00 +0700.</p>
        <p class="rss-subscribe">There is an <a href="/feed.xml">RSS feed</a>,
        but it's unused because this site is a wiki, not a blog.</p>
        <p>Stop writing books, papers, and blogs! Write a personal wiki instead! Or, even better, contribute to a community wiki.</p>
    </div>

</footer>


  </body>

</html>
